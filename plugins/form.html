<html>

<head>
    <title>Serial data injector</title>
    <script language="javascript">
        ddd = {};
        function buildForm() {
            root = document.getElementById("mainform");
            ddd.forEach(f => {
                div0 = document.createElement("div");
                div0.className = "row";
                div1 = document.createElement("div");
                div1.className = "caption";
                div2 = document.createElement("div");
                div2.id = "data_" + f.id;
                div1.innerText = f.title;
                div2.innerText = f.value;
                div2.contentEditable = true;
                div0.appendChild(div1);
                div0.appendChild(div2);
                root.appendChild(div0);
            })
        }
        function sendData() {
            ddd.forEach(f => {
                d = document.getElementById("data_" + f.id);
                f.value = d.innerText;
            });
            payload = ddd.map(o => {
                return {"id" : o.id, "value" : o.value};
            })
            body = JSON.stringify(payload)
            writeToLog("Sending " + body)
            fetch('/data', { method: 'POST', body: body })
                .then(resp => resp.text())
                .then(txt => writeToLog(txt))
            writeToLog("---------------------------")
        }

        function onload() {
            fetch('/data')
                .then(resp => resp.json())
                .then(data => {
                    ddd = data;
                    buildForm()
                })
                .then(() => writeToLog("Data loaded from server"))

        }
        function writeToLog(txt) {
            pre = document.getElementById("logPre");
            line = document.createElement("log");
            line.innerText = txt + "\n";
            pre.appendChild(line);
            pre.scrollTo(50,pre.scrollHeight);
        }
    </script>
</head>

<body onload="onload()">
    <h1>Serial data injector</h1>
    <div class="grid-container">
        <div class="grid-child purple">
            <div id="mainform"></div>
            <input type="button" onclick="sendData()" value="update">
        </div>
        <div class="grid-child green">
            <pre class="log" id="logPre"></pre>
        </div>
    </div>
    <hr>
</body>
<style>
    .row {
        padding-top: 10px;
    }

    .caption {
        background-color: cyan;
    }

    .grid-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 20px;
    }

    pre.log {
        white-space: pre-wrap;
        background-color: #EFEFEF;
        height: 200px;
        overflow: auto;
    }

    pre.log:before {
        counter-reset: listing;
    }

    pre.log log {
        counter-increment: listing;
    }

    pre.log log::before {
        content: counter(listing) ". ";
        display: inline-block;
        width: 82m;
        padding-left: auto;
        margin-left: auto;
        text-align: right;
    }
</style>

</html>